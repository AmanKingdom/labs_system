<!--apply_experiments/weeks_analyze.html-->

{% extends 'apply_experiments/base.html' %}

{% block add_css_to_apply_experiments %}
    <!--固定列表头所需的样式依赖-->
    <link rel="stylesheet" href="/static/css_js/css/fixed-columns/bootstrap-table-fixed-columns.css">
{% endblock %}

{% block apply_experiments_body %}
    <div class="row">
        <div id="toolbar">
            <div class="row">
                <div class="col-sm-4 m-b-xs">
                    <select class="input-sm form-control input-s-sm inline">
                        <option class="selected">计算机科学与技术学院</option>
                        <option>网络安全学院</option>
                    </select>
                </div>
                <div class="col-sm-4 m-b-xs">
                    <select class="input-sm form-control input-s-sm inline">
                        <option>第14周</option>
                        <option class="selected">第15周</option>
                        <option>第16周</option>
                    </select>
                </div>
                <div class="col-sm-4 m-b-xs">
                    <select class="input-sm form-control input-s-sm inline">
                        <option class="selected">--星期--</option>
                        <option>星期一</option>
                        <option>星期二</option>
                        <option>星期三</option>
                        <option>星期四</option>
                        <option>星期五</option>
                        <option>星期六</option>
                        <option>星期七</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="week_schedule_table"
               data-toggle="table"
               data-classes="table table-hover"
               data-show-columns="true"
               data-striped="true"
               data-show-toggle="true"
               data-search="true"
               data-show-refresh="true"
               data-toolbar="#toolbar"
               data-height="600"
               align="center">
        </table>
    </div>
{% endblock %}

{% block add_js_to_apply_experiments %}
    <!--固定列的js-->
    <script src="/static/css_js/js/fixed-columns/bootstrap-table-fixed-columns.js"></script>

    <!--固定列-->
    <script>
        $(function () {
            $('#week_schedule_table').bootstrapTable('destroy').bootstrapTable({
                minimumCountColumns:4,
                fixedColumns:true,
                fixedNumber:2,
            });
        })
    </script>

    <script>
        function initTable() {
            $('#week_schedule_table').bootstrapTable('destroy').bootstrapTable({
                sidePagination: "server",
                url: '{% url "super_manage:get_schedule" school.id %}',
                height: 550,
                locale: $('#locale').val(),
                onLoadSuccess: function (data) {
                    uniteTable('week_schedule_table', 6);
                },
                columns: [
                    {
                        field: 'days_of_the_week',
                        title: '星期',
                    }, {
                        field: 'section',
                        title: '节次',
                    },
                    {% for lab in labs %}
                        {
                            field: '{{ lab.name }}',
                            title: '{{ lab.name }}',
                        },
                    {% endfor %}
                ],
            });
        }


        //动态合并单元格
        function uniteTable(tableId,colLength) {//表格ID，表格列数
            var tb=document.getElementById(tableId);
            tb.style.display='';
            var i = 0;
            var j = 0;
            var rowCount = tb.rows.length; //   行数
            var colCount = tb.rows[0].cells.length; //   列数

            console.log(rowCount, colCount);

            var obj1 = null;
            var obj2 = null;
            //为每个单元格命名，包括表头
            for (i = 0; i < rowCount; i++) {
                for (j = 0; j < colCount; j++) {
                    tb.rows[i].cells[j].id = "tb__" + i.toString() + "_" + j.toString();
                    console.log(tb.rows[i].cells[j], tb.rows[i].cells[j].id);
                }
            }
            //合并行
            for (i = 0; i < colCount; i++) {
                if (i == colLength) break;
                obj1 = document.getElementById("tb__0_" + i.toString());
                for (j = 1; j < rowCount; j++) {
                    obj2 = document.getElementById("tb__" + j.toString() + "_" + i.toString());
                    if (obj1.innerText == obj2.innerText && ((obj2.innerText != "" || obj1.innerText != "")&&(obj1.innerText != "-"|| obj2.innerText != "-"))) {
                        obj1.rowSpan++;
                        obj2.parentNode.removeChild(obj2);
                    } else {
                        obj1 = document.getElementById("tb__" + j.toString() + "_" + i.toString());
                    }
                }
            }
            {#//合并列，出了点问题...#}
            {#for (i = 0; i < rowCount; i++) {#}
            {#    colCount = tb.rows[i].cells.length;#}
            {#    obj1 = document.getElementById(tb.rows[i].cells[0].id);#}
            {#    for (j = 1; j < colCount; j++) {#}
            {#        if (j >= colLength) break;#}
            {#        if (obj1.colSpan >= colLength) break;#}
            {#        obj2 = document.getElementById(tb.rows[i].cells[j].id);#}
            {#        if (obj1.innerText == obj2.innerText && ((obj2.innerText != "" || obj1.innerText != "")&&(obj1.innerText != "-"|| obj2.innerText != "-"))) {#}
            {#            obj1.colSpan++;#}
            {#            obj2.parentNode.removeChild(obj2);#}
            {#            j = j - 1;#}
            {#        }#}
            {#        else {#}
            {#            obj1 = obj2;#}
            {#            j = j + obj1.rowSpan;#}
            {#        }#}
            {#    }#}
            {#}#}
        }

        $(function() {
            initTable();
            $('#locale').change(initTable);
            {#uniteTable('week_schedule_table');#}
        })
    </script>
{% endblock %}
