<!--super_user/teacher_manage.html-->

{% extends 'apply_experiments/base.html' %}

{% block add_css %}
    <style>
        .table, .ibox{
            margin-bottom: 0;
        }
    </style>
{% endblock %}

{% block body_block %}
    {% if departments %}
        <div class="row">
            <div class="col-md-12">
                <br>
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>教师信息表</h5>
                        <div class="ibox-tools">
                            <button id="add_teacher_button" class="btn btn-primary">添加教师</button>
                            <button id="save_teacher_button" class="btn btn-primary">保存修改</button> |
                            <button id="remove_teacher_button" class="btn btn-danger" disabled>删除教师</button>
                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <table id="teacher_table"
                               class="table-responsive"
                               data-id-field="id"
                               data-response-handler="responseHandler"
                               data-click-to-select="true">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <hr>
        请先添加系别信息，有系别信息后可进行下一步设置 <a href="{% url 'super_manage:school_manage' %}">>>>前往添加</a>
    {% endif %}
{% endblock %}

{% block add_js %}
    <!--通用的ajax提交-->
    <script>
        function my_ajax(url, data) {
            $.ajax({
                cache:true,//保留缓存数据
                type:"POST",
                url:url,
                data:data,
                dataType:'JSON',
                async:true,
                headers:{'X-CSRFToken':'{{ csrf_token }}'},
                error:function(request){
                    console.log("无法提交", request);
                },
                success:function(data){
                    console.log("已提交");
                    console.log(data);
                    if(data.status){
                        console.log('提交成功！');
                        window.location.href="{% url 'super_manage:teacher_manage' %}"
                    }else{
                        console.log('提交信息有问题：'+data.message)
                    }
                }
            });
        }
    </script>

    <!--通用的保存方法-->
    <script>
        function save_ajax(save_objects_model, save_objects_data, school_id){
            var url = "{% url 'super_manage:save_ajax' %}";
            var data = JSON.stringify({'save_objects_model': save_objects_model, 'save_objects_data':save_objects_data, 'school_id': school_id});

            my_ajax(url, data);
        }
    </script>

    <!--通用的删除方法-->
    <script>
        function remove_ajax(remove_json){
            var url = "{% url 'super_manage:remove_ajax' %}";
            var data = JSON.stringify(remove_json);
            my_ajax(url, data);
        }
    </script>

    <!--通用的设置表信息和动态事件方法-->
    <script>
        // 此处的model传入字符串，用于标识对象是什么类型的模型
        function set_a_table(table, remove_button, model){
            function get_id_selections(table) {
                return $.map(table.bootstrapTable('getSelections'), function (row) {
                    return row.id
                })
            }

            function get_id_in_database_selections(table) {
                return $.map(table.bootstrapTable('getSelections'), function (row) {
                    return row.id_in_database
                })
            }

            // 隐藏数据库id列
            table.bootstrapTable('hideColumn', 'id_in_database');

            table.on('check.bs.table uncheck.bs.table ' + 'check-all.bs.table uncheck-all.bs.table',
                function () {
                    remove_button.prop('disabled', !table.bootstrapTable('getSelections').length);

                    // save your data, here just save the current page
                    selections = get_id_selections(table)
                    // push or splice the selections if you want to save all data selections
                }
            );
            table.on('all.bs.table', function (e, name, args) {
                console.log(name, args)
            });

            remove_button.click(function () {
                var ids = get_id_selections(table);
                var ids_in_database = get_id_in_database_selections(table);
                var model_name = "";
                if(model == 'school_areas'){
                    model_name = '校区'
                }else if(model == 'institutes'){
                    model_name = '学院'
                }else if(model == 'departments'){
                    model_name = '系别'
                }else if(model == 'grades'){
                    model_name = '年级'
                }else if(model == 'classes'){
                    model_name = '班级'
                }else if(model == 'teachers'){
                    model_name = '教师'
                }
                var remove_flag = confirm('您正在删除'+model_name+ids+'，将会连同该'+model_name+'下的所有子关联表都删除（如果有的话），确定删除吗？');

                if(remove_flag) {
                    var remove_json = {
                        "remove_objects_model": model,
                        "remove_ids": ids_in_database,
                    };

                    remove_ajax(remove_json);
                }else{
                    alert('我就知道你不想删除她的')
                }
            })
        }
    </script>


    <!--教师信息表设置相关  开始-->
    <script>
        var teacher_table = $('#teacher_table');
        var remove_teacher_button = $('#remove_teacher_button');
        var selections = [];

        function init_teacher_table() {
            console.log('init_teacher_table()执行');
            teacher_table.bootstrapTable('destroy').bootstrapTable({
                locale: $('#locale').val(),
                columns: [
                    [{
                        field: 'state',
                        checkbox: true,
                    }, {
                        title: '序号',
                        field: 'id',
                    },{
                        field:'department',
                        title: '所属系别<span class="need">*</span>',
                        editable:{
                            type:'select',
                            source: [
                                {% for department in departments %}
                                    { value: {{ department.id }}, text: '{{ department }}'},
                                {% empty %}
                                    { value:"", text: not_found_data},
                                {% endfor %}
                            ]
                        },
                    },{
                        field: 'teacher_name',
                        title: '教师姓名<span class="need">*</span>',
                        editable:{
                            type:'text',
                        },
                    },{
                        field: 'account',
                        title: '账号（工号）<span class="need">*</span>',
                        editable:{
                            type:'text',
                        },
                    },{
                        field: 'password',
                        title: '密码（默认为123456）<span class="need">*</span>',
                        editable:{
                            type:'text',
                        },
                    },{
                        field: 'phone',
                        title: '预留手机号码',
                        editable:{
                            type:'text',
                        },
                    },{
                        field:'id_in_database',
                    }]
                ]
            });

            set_a_table(teacher_table, remove_teacher_button, 'teachers');
        }

        function load_teacher(){
            console.log('load_teacher()执行');
            var index = 0;
            {% for teacher in teachers %}
                var new_row = {
                    "id": index,
                    'department': '{{ teacher.department.id }}',
                    'teacher_name': '{{ teacher.name }}',
                    'account': '{{ teacher.account }}',
                    'password': '{{ teacher.password }}',
                    'phone': {% if teacher.phone %}'{{ teacher.phone }}'{% else %}''{% endif %},
                    "id_in_database": '{{ teacher.id }}',
                };
                // 插入该行
                teacher_table.bootstrapTable('insertRow', {
                    index: index,
                    row: new_row
                });
                index = index + 1;
            {% empty %}
            {% endfor %}
        }

        $(function() {
            init_teacher_table();
            load_teacher();
            $('#locale').change(init_teacher_table);
        })
    </script>
    <!--教师信息表设置相关  结束-->

    <!--动态添加教师信息表格行 事件 开始-->
    <script>
        $("#add_teacher_button").click(function () {
            // 用index实现编号自增
            var data = teacher_table.bootstrapTable('getData');
            var index = data.length;

            var new_row = null;

            if(index == 0){
                new_row = {
                    "id": index,
                    "department": "",
                    "teacher_name": "",
                    "account": "",
                    "password": "123456",
                    "phone": "",
                };
            }else{
                new_row = {
                    "id": index,
                    "department": data[index-1].department,
                    "teacher_name": "",
                    "account": "",
                    "password": "123456",
                    "phone": "",
                };
            }

            // 最后插入该行
            teacher_table.bootstrapTable('insertRow', {
                index: index,
                row: new_row
            });
        });
    </script>
    <!--动态添加教师信息表格行 事件 结束-->

    <!--保存修改或增加教师信息后的表格 事件 开始 -->
    <script>
        $('#save_teacher_button').click(function () {
            var teachers = teacher_table.bootstrapTable('getData');

            if(teachers.length !== 0){
                var pass = true;
                $.each(teachers, function (index, value) {
                    console.log(index, value);

                    if(value['department'] === empty_text || value['department'] == ""){
                        pass = false;
                        window.alert('提交失败，请选择教师'+index+'所属系别');
                        return pass
                    }

                    if(value['teacher_name'] === empty_text || value['teacher_name'] == ""){
                        pass = false;
                        window.alert('提交失败，教师 '+index+'的姓名不可以为空');
                        return pass
                    }

                    if(value['account'] === empty_text || value['account'] == ""){
                        pass = false;
                        window.alert('提交失败，请填上教师'+index+'的账号');
                        return pass
                    }

                    if(value['password'] === empty_text || value['password'] == ""){
                        pass = false;
                        window.alert('提交失败，请填上教师'+index+'密码');
                        return pass
                    }
                });
                if(pass){
                    save_ajax('teachers', teachers, '{{ school.id }}')
                }
            }
        })
    </script>
    <!--保存修改或增加教师信息后的表格 事件 结束 -->
{% endblock %}